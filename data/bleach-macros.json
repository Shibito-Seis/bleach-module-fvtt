[
  {
    "_id": "uXrHq2Kp9aLm3Vt1",
    "name": "Bleach — Appliquer Shinigami (package v0.1)",
    "type": "script",
    "img": "systems/pf2e/icons/default-icons/mystery-man.svg",
    "scope": "global",
    "command": "// PF2E Bleach: Apply Shinigami package v0.1\n// Run as GM. Select a token (preferred) or have a character assigned.\n\nif (!game.user.isGM) {\n  ui.notifications.warn(\"Cette macro doit etre executee par le MJ.\");\n  return;\n}\n\nconst actor = canvas?.tokens?.controlled?.[0]?.actor ?? game.user.character;\nif (!actor) {\n  ui.notifications.error(\"Selectionne un token (ou assigne un personnage a ton utilisateur) avant de lancer la macro.\");\n  return;\n}\n\nconst pack = game.packs.get(\"world.bleach-items\");\nif (!pack) {\n  ui.notifications.error(\"Compendium introuvable: world.bleach-items\");\n  return;\n}\n\nasync function getByName(name) {\n  await pack.getIndex();\n  const entry = pack.index.find(e => (e.name ?? \"\").trim() === name);\n  if (!entry) return null;\n  return await pack.getDocument(entry._id);\n}\n\nasync function addItemByName(name) {\n  const doc = await getByName(name);\n  if (!doc) {\n    ui.notifications.error(`Document manquant dans le compendium: ${name}`);\n    return null;\n  }\n  // Avoid duplicates by name+type\n  const exists = actor.items.some(i => i.name === doc.name && i.type === doc.type);\n  if (exists) return null;\n  return await actor.createEmbeddedDocuments(\"Item\", [doc.toObject()]);\n}\n\nconst axes = {\n  physique: \"Axe de combat — Physique\",\n  spirituel: \"Axe de combat — Spirituel\",\n  equilibre: \"Axe de combat — Équilibré\",\n};\n\nconst content = `\n<p><strong>Appliquer Shinigami (package v0.1)</strong></p>\n<p>Choisis l'axe de combat a appliquer sur <em>${actor.name}</em>.</p>`;\n\nnew Dialog({\n  title: \"Bleach — Shinigami v0.1\",\n  content,\n  buttons: {\n    physique: {\n      label: \"Physique\",\n      callback: async () => {\n        await addItemByName(\"Zanpakutō scellée\");\n        await addItemByName(\"Transformation — Shikai (Verrouillé)\");\n        await addItemByName(axes.physique);\n        await actor.setFlag(\"pf2e-bleach\", \"origin\", \"shinigami\");\n        await actor.setFlag(\"pf2e-bleach\", \"axis\", \"physique\");\n        ui.notifications.info(`Package Shinigami applique: ${actor.name} (Physique)`);\n      }\n    },\n    spirituel: {\n      label: \"Spirituel\",\n      callback: async () => {\n        await addItemByName(\"Zanpakutō scellée\");\n        await addItemByName(\"Transformation — Shikai (Verrouillé)\");\n        await addItemByName(axes.spirituel);\n        await actor.setFlag(\"pf2e-bleach\", \"origin\", \"shinigami\");\n        await actor.setFlag(\"pf2e-bleach\", \"axis\", \"spirituel\");\n        ui.notifications.info(`Package Shinigami applique: ${actor.name} (Spirituel)`);\n      }\n    },\n    equilibre: {\n      label: \"Équilibre\",\n      callback: async () => {\n        await addItemByName(\"Zanpakutō scellée\");\n        await addItemByName(\"Transformation — Shikai (Verrouillé)\");\n        await addItemByName(axes.equilibre);\n        await actor.setFlag(\"pf2e-bleach\", \"origin\", \"shinigami\");\n        await actor.setFlag(\"pf2e-bleach\", \"axis\", \"equilibre\");\n        ui.notifications.info(`Package Shinigami applique: ${actor.name} (Équilibre)`);\n      }\n    },\n    cancel: {\n      label: \"Annuler\"\n    }\n  },\n  default: \"physique\"\n}).render(true);"
  }
]